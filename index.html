<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" type="image/jpeg" href="https://i.imgur.com/HziCJbE.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIDROART - Orçamentos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Definindo as novas cores */
    :root {
      --main-green: #1E8449; /* Verde principal um pouco mais escuro */
      --dark-bg: #1a1a1a;
      --light-text: #f8f9fa;
      --light-gray: #f0f0f0;
      --border-color: #cccccc;
      --text-color: #333333;
    }

    body {
      font-family: 'Open Sans', sans-serif; /* Fonte mais suave para o corpo */
      background-color: var(--dark-bg); /* Preto suave */
      color: var(--light-text); /* Off-white para o texto padrão */
      line-height: 1.6;
      /* Efeito de iluminação verde no topo, ajustado para o novo tom */
      background-image: linear-gradient(to bottom, rgba(30, 132, 73, 0.3), rgba(30, 132, 73, 0) 30%, var(--dark-bg) 60%);
      background-attachment: fixed; /* Para que o gradiente fique fixo no topo da viewport */
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% 100vh; /* Ocupa a largura total e a altura da viewport */
    }
    h1, h2, h3, h4 {
      font-family: 'Montserrat', sans-serif; /* Montserrat para títulos */
    }

    .glass-card {
      backdrop-filter: blur(15px); /* Blur mais sutil */
      background: rgba(255, 255, 255, 0.08); /* Fundo quase transparente, mais elegante */
      border-radius: 1.25rem; /* Bordas mais arredondadas */
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); /* Sombra mais pronunciada */
      transition: all 0.4s ease-in-out;
    }
    .glass-card:hover {
      transform: translateY(-8px) scale(1.01); /* Efeito de "levantar" mais acentuado */
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
      background: rgba(255, 255, 255, 0.12); /* Levemente mais opaco no hover */
    }

    .input-field {
      width: 100%;
      background: rgba(0, 0, 0, 0.4); /* Fundo mais transparente */
      border-radius: 0.5rem; /* Bordas mais arredondadas */
      padding: 0.75rem 1rem; /* Padding maior */
      outline: none;
      color: var(--light-text); /* Off-white */
      transition: background 0.3s ease, box-shadow 0.3s ease;
      border: none;
    }
    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.6); /* Placeholder mais suave */
    }
    .input-field:focus {
      background: rgba(0, 0, 0, 0.6); /* Fundo um pouco mais escuro no foco */
      box-shadow: 0 0 0 3px var(--main-green); /* Sombra verde principal no foco */
    }
    .input-field[type="checkbox"] {
        background: rgba(0, 0, 0, 0.5);
        color: var(--main-green); /* Verde principal para o check */
        appearance: none; /* Remover estilo padrão */
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 1.25rem; /* Tamanho maior */
        height: 1.25rem;
        border-radius: 0.25rem;
        cursor: pointer;
        position: relative;
        display: inline-block;
        vertical-align: middle;
        border: none;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3); /* Borda interna sutil */
    }
    .input-field[type="checkbox"]:checked {
        background-color: var(--main-green); /* Verde principal quando checado */
        box-shadow: inset 0 0 0 1px var(--main-green); /* Sombra interna verde */
    }
    .input-field[type="checkbox"]:checked::before {
        content: '\2713'; /* Ícone de check */
        display: block;
        color: white;
        font-size: 0.8rem;
        text-align: center;
        line-height: 1.25rem;
    }
    /* Estilo específico para o input de cor */
    .input-field[type="color"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 40px; /* Largura menor para a caixa de cor */
      height: 40px; /* Altura menor para a caixa de cor */
      border: none;
      padding: 0;
      background: none;
      cursor: pointer;
      border-radius: 0.5rem; /* Bordas arredondadas */
      overflow: hidden; /* Para garantir que a cor preencha o border-radius */
    }
    .input-field[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .input-field[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 0.5rem;
    }
    .input-field[type="color"]::-moz-color-swatch-wrapper {
      padding: 0;
    }
    .input-field[type="color"]::-moz-color-swatch {
      border: none;
      border-radius: 0.5rem;
    }

    .btn-green {
      background-color: var(--main-green); /* Verde principal */
      color: white;
      padding: 0.8rem 2rem; /* Padding maior */
      border-radius: 0.5rem; /* Bordas mais arredondadas */
      display: inline-flex; /* Usar inline-flex para centralizar ícone e texto */
      gap: 0.75rem; /* Espaçamento maior */
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.05em; /* Espaçamento entre letras */
      text-transform: uppercase; /* Texto em maiúsculas */
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 15px rgba(30, 132, 73, 0.4); /* Ajustado para o novo verde */
      border: none; /* Remover borda */
    }
    .btn-green:hover {
      background-color: #186F3E; /* Verde escuro no hover */
      transform: translateY(-3px); /* Efeito de "levantar" */
      box-shadow: 0 6px 20px rgba(30, 132, 73, 0.6);
    }
    /* Estilo para o botão preto */
    .btn-black {
      background-color: #343a40; /* Cor preta suave */
      color: white;
      padding: 0.8rem 2rem;
      border-radius: 0.5rem;
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 15px rgba(52, 58, 64, 0.4);
      border: none;
    }
    .btn-black:hover {
      background-color: var(--dark-bg); /* Preto suave no hover */
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(52, 58, 64, 0.6);
    }

    .product-item {
      display: flex;
      align-items: center;
      gap: 1.5rem; /* Espaçamento maior */
      padding: 1.25rem; /* Padding maior */
      background: rgba(0, 0, 0, 0.3); /* Fundo mais transparente */
      border-radius: 0.75rem; /* Bordas mais arredondadas */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Sombra mais suave */
      transition: all 0.3s ease-in-out;
      border: none; /* Remover borda */
    }
    .product-item:hover {
      transform: scale(1.01);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      background: rgba(0, 0, 0, 0.4);
    }
    .product-item img {
      width: 80px; /* Tamanho maior */
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem; /* Bordas mais arredondadas */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* Sombra sutil na imagem */
    }
    .product-item p {
        color: var(--light-text); /* Off-white */
    }
    .product-item p.font-semibold {
        color: var(--light-text); /* Off-white */
        font-size: 1.1rem; /* Fonte maior */
    }
    .product-item p.text-sm {
        color: rgba(255, 255, 255, 0.7); /* Texto menor mais suave */
    }
    .product-item p.text-md {
        color: #6cda80; /* Manter um verde claro para destaque de valor */
        font-weight: 700; /* Mais negrito */
        font-size: 1.15rem; /* Fonte maior */
    }
    .product-item .action-buttons {
        display: flex;
        gap: 0.75rem; /* Espaçamento entre os botões de ação */
        margin-left: auto; /* Empurra os botões para a direita */
    }
    .product-item button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        font-size: 1.4rem; /* Ícone maior */
        transition: color 0.2s ease;
    }
    .product-item button.delete-btn {
        color: #dc3545; /* Vermelho para o lixo */
    }
    .product-item button.delete-btn:hover {
        color: #c82333; /* Vermelho mais escuro no hover */
    }
    .product-item button.edit-btn {
        color: #007bff; /* Azul para o editar */
    }
    .product-item button.edit-btn:hover {
        color: #0056b3; /* Azul mais escuro no hover */
    }
    .product-item .color-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: inline-block;
      vertical-align: middle;
      margin-right: 5px; /* Espaçamento à direita para separar do texto */
    }

    /* Animações de entrada */
    .animate-fade-in {
      animation: fadeIn 1s ease-out forwards;
      opacity: 0;
    }
    .animate-slide-up {
      animation: slideUp 1s ease-out forwards;
      opacity: 0;
      transform: translateY(30px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Ajustes para o fundo da seção de orçamento */
    #orcamento {
        background-color: transparent; /* Fundo transparente para ver o gradiente do body */
        color: var(--light-text); /* Off-white */
    }
    #orcamento h3 {
        color: var(--light-text); /* Título da seção off-white */
    }
    #produtosAdicionadosContainer h4 {
        color: var(--light-text); /* Título dos produtos adicionados off-white */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Linha divisória sutil */
    }
    #noProductsMessage {
        color: rgba(255, 255, 255, 0.6); /* Mensagem de nenhum produto mais suave */
    }
    .flex.items-center.gap-2 label {
        color: var(--light-text); /* Label do checkbox off-white */
    }
    hr {
        border-color: rgba(255, 255, 255, 0.1); /* Linha divisória mais escura e sutil */
    }

    /* Ajuste para o cabeçalho */
    header {
      background-color: transparent; /* Fundo transparente para ver o gradiente do body */
      padding-top: 1.5rem; /* py-6 */
      padding-bottom: 1.5rem;
      box-shadow: none; /* Remover sombra */
    }
    header .max-w-7xl { /* Remover max-width e padding laterais do container interno do header */
        max-width: none;
        padding-left: 0;
        padding-right: 0;
    }
    header h1, header nav { /* Adicionar padding interno para o texto do header */
        padding-left: 2rem; /* px-8 */
        padding-right: 2rem; /* px-8 */
    }
    header h1 {
        font-size: 2.5rem; /* Título maior */
        font-weight: 700;
        letter-spacing: 0.08em; /* Mais espaçamento */
    }
    header nav a {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
        border-radius: 0.3rem;
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    header nav a:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--main-green); /* Verde principal no hover */
    }

    /* Ajuste para a seção hero */
    .hero-section { /* Nova classe para a seção hero */
      background-color: transparent; /* Fundo transparente para ver o gradiente do body */
      padding-left: 0; /* Remover padding lateral */
      padding-right: 0; /* Remover padding lateral */
      padding-top: 8rem; /* Más padding */
      padding-bottom: 8rem; /* Más padding */
      box-shadow: none; /* Remover sombra */
    }
    .hero-section > div { /* Adicionar padding interno para o conteúdo do hero */
        max-width: 4xl; /* Aumentar o max-width para el contenido */
        margin-left: auto;
        margin-right: auto;
        padding-left: 2rem; /* px-8 */
        padding-right: 2rem; /* px-8 */
    }
    .hero-section h2 {
        font-size: 3.8rem; /* Título mayor */
        font-weight: 700;
        line-height: 1.2;
        text-shadow: none; /* Remover sombra */
        margin-bottom: 1.5rem;
    }
    .hero-section p {
        font-size: 1.4rem; /* Texto mayor */
        opacity: 0.95;
        text-shadow: none; /* Remover sombra */
    }

    /* Ajuste para a seção de orçamento */
    #orcamento {
        padding-top: 5rem; /* py-20 */
        padding-bottom: 5rem;
        background-color: transparent; /* Fundo transparente para ver o gradiente do body */
    }
    #orcamento > div { /* Adicionar padding interno para o conteúdo do orçamento */
        max-width: 5xl; /* Manter o max-width para el contenido */
        margin-left: auto;
        margin-right: auto;
        padding-left: 2rem; /* px-8 */
        padding-right: 2rem; /* px-8 */
    }
    #orcamento h3 {
        font-size: 3rem; /* Título mayor */
        font-weight: 700;
        margin-bottom: 3rem; /* Espaçamento mayor */
        text-shadow: none; /* Remover sombra */
    }

    /* Ajuste para o rodapé */
    footer {
      background-color: transparent; /* Fundo transparente para ver o gradiente do body */
      color: var(--light-text); /* Off-white */
      text-align: center;
      padding: 2.5rem; /* Padding mayor */
      margin-top: 6rem; /* Espaçamento mayor do conteúdo */
      box-shadow: none; /* Remover sombra */
      padding-left: 0; /* Remover padding lateral */
      padding-right: 0; /* Remover padding lateral */
    }
    footer p { /* Adicionar padding interno para o texto do rodapé */
        padding-left: 2rem; /* px-8 */
        padding-right: 2rem; /* px-8 */
        font-size: 0.95rem;
        opacity: 0.8;
    }

    /* Estilos para a barra de progresso de rolagem */
    #progressBarContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px; /* Altura da barra */
      background-color: rgba(0, 0, 0, 0.2); /* Fundo da barra (transparente) */
      z-index: 1000; /* Garante que fique acima de outros elementos */
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background-color: var(--main-green); /* Cor da barra de progresso */
      transition: width 0.1s ease-out; /* Transição suave para a largura */
    }
  </style>
</head>
<body class="min-h-screen"> 
  <!-- Barra de Progresso de Rolagem -->
  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>

  <header class="text-white py-6">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold tracking-wide flex items-center gap-3">
  <img src="https://i.imgur.com/HziCJbE.png" alt="Logo VIDROART" class="w-12 h-12 rounded-lg">
  𝑽𝑰𝑫𝑹𝑶𝑨𝑹𝑻
</h1>

      <nav class="space-x-6 text-lg">
        <a href="#orcamento" class="hover:underline">Orçamento</a>
      </nav>
    </div>
  </header>

  <section class="text-center py-20 px-4 hero-section text-white">
    <div class="max-w-3xl mx-auto p-8 rounded-2xl animate-fade-in">
      <h2 class="text-5xl font-bold mb-4 leading-tight">GERADOR DE ORÇAMENTOS PRIVADO</h2>
      <p class="text-xl opacity:90">Portas, janelas, box e projetos sob medida para melhor performance e agilidade.</p>
    </div>
  </section>

  <section id="orcamento" class="py-16">
    <div class="max-w-6xl mx-auto px-4">
      <h3 class="text-4xl font-bold text-center mb-12 animate-slide-up">Painel de Geração de Orçamentos</h3>
      <div class="glass-card p-10 animate-slide-up">
        <form class="space-y-8" onsubmit="return false;">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <input type="text" id="clienteNome" placeholder="Nome do Cliente" class="input-field">
            <input type="text" id="clienteTelefone" placeholder="Telefone" class="input-field">
            <input type="email" id="clienteEmail" placeholder="E-mail" class="input-field">
            <input type="text" id="clienteEndereco" placeholder="Endereço da Obra" class="input-field">
            <div class="flex flex-col gap-2">
  <label for="percentualDesconto" class="font-medium text-gray-300">
    Desconto (%): <span id="valorDescontoLabel" class="text-green-400 font-semibold">0%</span>
  </label>
  <input type="range" id="percentualDesconto" min="0" max="10" step="0.5" value="0"
         class="w-full accent-green-600 cursor-pointer">
</div>
          </div>
          <hr class="my-8">
          <div class="grid grid-cols-1 gap-6">
            <input type="text" id="produtoNome" placeholder="Produto (ex: Box Incolor 8mm)" class="input-field">
            <div class="grid grid-cols-2 gap-6">
              <input type="number" id="produtoLargura" placeholder="Largura (mm)" class="input-field">
              <input type="number" id="produtoAltura" placeholder="Altura (mm)" class="input-field">
            </div>
            <input type="number" id="produtoQtd" placeholder="Quantidade" value="1" class="input-field">
            <input type="text" id="produtoVidro" placeholder="Vidro (ex: temperado, fumê, etc.)" class="input-field">
            <input type="number" step="0.01" id="produtoArea" placeholder="Área Total (m²) (Opcional)" class="input-field">
            <input type="number" step="0.01" id="produtoUnitario" placeholder="Valor Unitário (R$)" class="input-field">
            
            <!-- CAMPO DE COR -->
            <div class="flex items-center gap-4">
              <label for="produtoCor" class="font-medium text-gray-300">Cor:</label>
              <input type="color" id="produtoCor" value="#ffffff" class="input-field">
              <input type="text" id="produtoCorNome" placeholder="Nome da Cor (ex: Bronze, Fumê)" class="input-field flex-grow">
            </div>
            <!-- FIM CAMPO DE COR -->

            <input type="file" accept="image/*" id="produtoFoto" class="input-field">
          </div>
          <div class="flex justify-center gap-6 pt-4">
  <button type="button" class="btn-green" id="adicionarProdutoBtn" onclick="adicionarProduto()">
    <i class="fas fa-plus mr-2"></i> Adicionar Produto
  </button>
  
  <button type="button" class="btn-green hidden" id="salvarEdicaoBtn" onclick="salvarEdicaoProduto()">
    <i class="fas fa-save mr-2"></i> Salvar Edição
  </button>
  
  <button type="button" class="btn-black" onclick="gerarPDF()">
    <i class="fas fa-file-pdf mr-2"></i> Gerar Orçamento
  </button>

  <button id="btnHistorico" type="button" 
    class="bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold transition">
    📜 Ver Histórico de Orçamentos
  </button>
</div>
          </div>
        </form>

        <div id="produtosAdicionadosContainer" class="mt-12 space-y-6 animate-slide-up">
          <h4 class="text-2xl font-bold border-b-2 pb-2">Produtos Adicionados:</h4>
          <div id="listaProdutos" class="space-y-4">
            <!-- Produtos adicionados serão listados aqui -->
            <p class="text-gray-500" id="noProductsMessage">Nenhum produto adicionado ainda.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="text-white text-center py-8 mt-20">
    <p class="text-sm">&copy; 2025 VIDROART. Todos os direitos reservados.</p>
  </footer>
    
  <!-- 🧾 Modal do Histórico -->
<div id="modalHistorico" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
  <div class="bg-white p-6 rounded-2xl w-11/12 max-w-lg shadow-2xl text-gray-800">
    <h2 class="text-2xl font-bold mb-4 text-center text-green-800">Histórico de Orçamentos</h2>
    <!-- 💰 Gestão Financeira -->
<section id="gestaoFinanceira" class="bg-white/60 backdrop-blur-md shadow-md rounded-2xl p-4 mb-6">
  <h2 class="text-lg font-bold text-gray-800 mb-2">💰 Gestão Financeira</h2>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
    <div class="p-3 bg-green-100 rounded-xl text-center">
      <p class="text-gray-600 font-semibold">Total Orçado</p>
      <p id="totalOrcado" class="text-lg font-bold text-green-700">R$ 0,00</p>
    </div>
    <div class="p-3 bg-blue-100 rounded-xl text-center">
      <p class="text-gray-600 font-semibold">Total Aprovado</p>
      <p id="totalAprovado" class="text-lg font-bold text-blue-700">R$ 0,00</p>
    </div>
    <div class="p-3 bg-amber-100 rounded-xl text-center">
      <p class="text-gray-600 font-semibold">Lucro Estimado</p>
      <p id="lucroEstimado" class="text-lg font-bold text-amber-700">R$ 0,00</p>
    </div>
    <div class="p-3 bg-purple-100 rounded-xl text-center">
      <p class="text-gray-600 font-semibold">% Conversão</p>
      <p id="percentualConversao" class="text-lg font-bold text-purple-700">0%</p>
    </div>
  </div>
  <div class="flex justify-end mt-4 gap-2">
    <button onclick="exportarRelatorio('pdf')" class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700">📄 PDF</button>
    <button onclick="exportarRelatorio('excel')" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">📊 Excel</button>
  </div>
</section>

<ul id="listaHistorico" class="text-gray-700 mb-4 max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50"></ul>

    <div class="flex justify-between items-center">
      <button id="limparHistorico" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">🧹 Limpar Tudo</button>
      <button id="fecharHistorico" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">Fechar</button>
    </div>
  </div>
</div>
  <script>
    // Array para armazenar os produtos adicionados
    let produtosAdicionados = [];
    let produtoEmEdicaoIndex = -1; // Variável para controlar qual produto está sendo editado

    // Função para adicionar um produto à lista
    async function adicionarProduto() {
      const nomeProduto = document.getElementById("produtoNome").value;
      const largura = document.getElementById("produtoLargura").value;
      const altura = document.getElementById("produtoAltura").value;
      const qtd = document.getElementById("produtoQtd").value;
      const vidro = document.getElementById("produtoVidro").value;
      const area = document.getElementById("produtoArea").value; // Área agora é opcional
      const unitario = document.getElementById("produtoUnitario").value;
      const fotoFile = document.getElementById("produtoFoto").files[0];
      const corHex = document.getElementById("produtoCor").value; // Captura o valor HEX da cor
      const corNome = document.getElementById("produtoCorNome").value; // Captura o nome da cor
      let fotoDataURL = '';

      // Validação básica dos campos (Área Total não é mais obrigatória)
      if (!nomeProduto || !largura || !altura || !qtd || !vidro || !unitario) {
        alert("Por favor, preencha todos os campos obrigatórios do produto (exceto Área Total) antes de adicionar.");
        return;
      }

      // Converte a imagem para DataURL se houver uma
      if (fotoFile) {
        fotoDataURL = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(fotoFile);
        });
      }

      // Calcula o valor total
      const total = parseFloat(unitario) * parseFloat(qtd); 

      // Cria o objeto do novo produto
      const novoProduto = {
        nome: nomeProduto,
        largura: largura,
        altura: altura,
        quantidade: qtd,
        vidro: vidro,
        area: area, // Área pode ser vazia
        valorUnitario: unitario,
        valorTotal: total, // Valor total é calculado aqui
        foto: fotoDataURL,
        corHex: corHex, // Adiciona a cor HEX
        corNome: corNome // Adiciona o nome da cor
      };

      // Adiciona o produto ao array
      produtosAdicionados.push(novoProduto);
      // Atualiza a exibição na página
      renderizarProdutosAdicionados();
      // Limpa os campos do formulário de produto
      limparCamposProduto();
    }

    // Função para renderizar os produtos adicionados na página
    function renderizarProdutosAdicionados() {
      const listaProdutosDiv = document.getElementById("listaProdutos");
      listaProdutosDiv.innerHTML = ''; // Limpa a lista existente

      if (produtosAdicionados.length === 0) {
        listaProdutosDiv.innerHTML = '<p class="text-gray-500" id="noProductsMessage">Nenhum produto adicionado ainda.</p>';
        return;
      }

      // Remove a mensagem "Nenhum produto adicionado" se houver produtos
      document.getElementById("noProductsMessage")?.remove(); 

      // Adiciona cada produto à lista na página
      produtosAdicionados.forEach((produto, index) => {
        const productItemDiv = document.createElement('div');
        productItemDiv.className = 'product-item';
        productItemDiv.innerHTML = `
          ${produto.foto ? `<img src="${produto.foto}" alt="${produto.nome}">` : ''}
          <div>
            <p class="font-semibold">${produto.nome} (${produto.largura}x${produto.altura}mm)</p>
            <p class="text-sm">Qtd: ${produto.quantidade} | Vidro: ${produto.vidro}
            ${produto.corNome ? ` | Cor: <span class="color-box" style="background-color: ${produto.corHex};"></span>${produto.corNome}` : ''}
            ${produto.area ? ` | Área: ${produto.area}m²` : ''}
            </p>
            <p class="text-md font-bold">Valor Unitário: R$ ${parseFloat(produto.valorUnitario).toFixed(2)} | Valor Total: R$ ${parseFloat(produto.valorTotal).toFixed(2)}</p>
          </div>
          <div class="action-buttons">
            <button type="button" class="edit-btn" onclick="editarProduto(${index})">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="delete-btn" onclick="removerProduto(${index})">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        listaProdutosDiv.appendChild(productItemDiv);
      });
    }

    // Função para remover um produto da lista
    function removerProduto(index) {
      if (confirm("Tem certeza que deseja remover este produto?")) {
        produtosAdicionados.splice(index, 1); // Remove o produto do array
        renderizarProdutosAdicionados(); // Renderiza a lista novamente
        // Se o produto removido era o que estava em edição, reseta o estado de edição
        if (produtoEmEdicaoIndex === index) {
          limparCamposProduto();
          document.getElementById("adicionarProdutoBtn").classList.remove("hidden");
          document.getElementById("salvarEdicaoBtn").classList.add("hidden");
          produtoEmEdicaoIndex = -1;
        }
      }
    }

    // Função para editar um produto
    function editarProduto(index) {
      const produto = produtosAdicionados[index];
      
      // Preenche os campos do formulário com os dados do produto
      document.getElementById("produtoNome").value = produto.nome;
      document.getElementById("produtoLargura").value = produto.largura;
      document.getElementById("produtoAltura").value = produto.altura;
      document.getElementById("produtoQtd").value = produto.quantidade;
      document.getElementById("produtoVidro").value = produto.vidro;
      document.getElementById("produtoArea").value = produto.area;
      document.getElementById("produtoUnitario").value = produto.valorUnitario;
      document.getElementById("produtoCor").value = produto.corHex;
      document.getElementById("produtoCorNome").value = produto.corNome;
      // Não é possível preencher o input de arquivo por segurança, o usuário terá que selecionar novamente se quiser mudar a foto.
      document.getElementById("produtoFoto").value = ''; 

      // Esconde o botão "Adicionar Produto" e mostra o botão "Salvar Edição"
      document.getElementById("adicionarProdutoBtn").classList.add("hidden");
      document.getElementById("salvarEdicaoBtn").classList.remove("hidden");

      // Armazena o índice do produto que está sendo editado
      produtoEmEdicaoIndex = index;

      // Rola a página para o formulário de edição
      document.getElementById("orcamento").scrollIntoView({ behavior: 'smooth' });
    }

    // Função para salvar a edição de um produto
    async function salvarEdicaoProduto() {
      if (produtoEmEdicaoIndex === -1) {
        alert("Nenhum produto selecionado para edição.");
        return;
      }

      const nomeProduto = document.getElementById("produtoNome").value;
      const largura = document.getElementById("produtoLargura").value;
      const altura = document.getElementById("produtoAltura").value;
      const qtd = document.getElementById("produtoQtd").value;
      const vidro = document.getElementById("produtoVidro").value;
      const area = document.getElementById("produtoArea").value;
      const unitario = document.getElementById("produtoUnitario").value;
      const fotoFile = document.getElementById("produtoFoto").files[0];
      const corHex = document.getElementById("produtoCor").value;
      const corNome = document.getElementById("produtoCorNome").value;
      let fotoDataURL = produtosAdicionados[produtoEmEdicaoIndex].foto; // Mantém a foto existente se nenhuma nova for selecionada

      if (!nomeProduto || !largura || !altura || !qtd || !vidro || !unitario) {
        alert("Por favor, preencha todos os campos obrigatórios do produto (exceto Área Total) antes de salvar a edição.");
        return;
      }

      if (fotoFile) {
        fotoDataURL = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(fotoFile);
        });
      }

      const total = parseFloat(unitario) * parseFloat(qtd);

      // Atualiza o produto no array
      produtosAdicionados[produtoEmEdicaoIndex] = {
        nome: nomeProduto,
        largura: largura,
        altura: altura,
        quantidade: qtd,
        vidro: vidro,
        area: area,
        valorUnitario: unitario,
        valorTotal: total,
        foto: fotoDataURL,
        corHex: corHex,
        corNome: corNome
      };

      // Renderiza a lista novamente
      renderizarProdutosAdicionados();
      // Limpa os campos do formulário
      limparCamposProduto();
      // Reseta o estado de edição
      document.getElementById("adicionarProdutoBtn").classList.remove("hidden");
      document.getElementById("salvarEdicaoBtn").classList.add("hidden");
      produtoEmEdicaoIndex = -1;
    }

    // Função para limpar os campos do formulário de produto
    function limparCamposProduto() {
      document.getElementById("produtoNome").value = '';
      document.getElementById("produtoLargura").value = '';
      document.getElementById("produtoAltura").value = '';
      document.getElementById("produtoQtd").value = '1';
      document.getElementById("produtoVidro").value = '';
      document.getElementById("produtoArea").value = ''; // Limpa o campo de área
      document.getElementById("produtoUnitario").value = '';
      document.getElementById("produtoFoto").value = ''; // Limpa o input de arquivo
      document.getElementById("produtoCor").value = '#ffffff'; // Reseta a cor para branco
      document.getElementById("produtoCorNome").value = ''; // Limpa o nome da cor
    }

    // Atualiza o valor do desconto conforme o usuário arrasta o slider
const sliderDesconto = document.getElementById("percentualDesconto");
const labelDesconto = document.getElementById("valorDescontoLabel");

if (sliderDesconto) {
  sliderDesconto.addEventListener("input", () => {
    labelDesconto.textContent = `${sliderDesconto.value}%`;
  });
}

    // Função principal para gerar o PDF
    async function gerarPDF() {
      if (produtosAdicionados.length === 0) {
        alert("Por favor, adicione pelo menos um produto ao orçamento antes de gerar o PDF.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");
      const margin = 8; // Margem geral
      let y = margin;
      const lineSpacing = 3.8; // Espaçamento entre linhas
      const sectionPadding = 4; // Espaçamento interno das seções
      const headerColor = '#1E8449'; // Verde principal
      const textColor = '#333333'; // Cor de texto padrão
      const lightGray = '#f0f0f0'; // Fundo de seções
      const borderColor = '#cccccc'; // Cor da borda

      // URL do logo (SUBSTITUA PELA URL DIRETA DO SEU LOGO)
      const logoUrl = 'https://i.imgur.com/HziCJbE.png'; 
      let logoImg = null;

      if (logoUrl) {
        try {
          const response = await fetch(logoUrl);
          const blob = await response.blob();
          logoImg = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error("Erro ao carregar o logo:", error);
          // Opcional: alertar o usuário ou usar um fallback de texto
        }
      }

      // --- Cabeçalho do Documento ---
      doc.setFillColor(headerColor);
      doc.rect(0, 0, doc.internal.pageSize.width, 22, 'F');

      if (logoImg) {
        doc.addImage(logoImg, 'PNG', margin, 2, 16, 16); // Alinhado à esquerda
      } else {
        doc.setFontSize(14);
        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, "bold");
        doc.text("VIDROART", margin, 13); // Alinhado à esquerda
      }

      doc.setFontSize(8);
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, "normal");
      // Informações de contato da empresa alinhadas à direita
      doc.text("Avenida Frei Florentino, 214, Centro, Muzambinho", doc.internal.pageSize.width - margin, 4, { align: "right" });
      doc.text("CNPJ: 19.397.220.0001/29", doc.internal.pageSize.width - margin, 8, { align: "right" });
      doc.text("Telefone: (35)3571-5750", doc.internal.pageSize.width - margin, 12, { align: "right" });
      doc.text("WhatsApp: (35)99162-4506", doc.internal.pageSize.width - margin, 16, { align: "right" });

      y = 30; // Posição inicial após o cabeçalho

      // --- Título "ORÇAMENTO" Centralizado e Estilizado ---
      const titleText = "ORÇAMENTO";
      const titleFontSize = 20;
      doc.setFontSize(titleFontSize);
      doc.setTextColor(headerColor);
      doc.setFont(undefined, "bold");

      const textWidth = doc.getStringUnitWidth(titleText) * titleFontSize / doc.internal.scaleFactor;
      const centerX = (doc.internal.pageSize.width - textWidth) / 2;

      const titleRectHeight = 9;
      const titleRectWidth = textWidth + 8;
      const titleRectX = (doc.internal.pageSize.width - titleRectWidth) / 2;
      const titleRectY = y - 2;

      doc.setFillColor(lightGray);
      doc.rect(titleRectX, titleRectY, titleRectWidth, titleRectHeight, 'F');
      doc.setDrawColor(headerColor);
      doc.setLineWidth(0.5);
      doc.rect(titleRectX, titleRectY, titleRectWidth, titleRectHeight, 'S');

      doc.setTextColor(headerColor);
      doc.text(titleText, centerX, y + 5); // Centralizado
      y += titleRectHeight + 4;
      doc.setDrawColor(headerColor);
      doc.setLineWidth(0.4);
      doc.line(margin, y, doc.internal.pageSize.width - margin, y);
      y += 5;

      // --- Dados do Cliente ---
      doc.setFillColor(lightGray);
      doc.rect(margin, y, doc.internal.pageSize.width - 2 * margin, 32, 'F');
      doc.setDrawColor(borderColor);
      doc.rect(margin, y, doc.internal.pageSize.width - 2 * margin, 32, 'S');

      doc.setFontSize(9);
      doc.setTextColor(headerColor);
      doc.setFont(undefined, "bold");
      doc.text("DADOS DO CLIENTE", margin + sectionPadding, y + sectionPadding); // Alinhado à esquerda

      doc.setFontSize(8);
      doc.setTextColor(textColor);
      doc.setFont(undefined, "normal");
      doc.text(`Nome: ${document.getElementById("clienteNome").value}`, margin + sectionPadding, y + sectionPadding + 4); // Alinhado à esquerda
      doc.text(`Telefone: ${document.getElementById("clienteTelefone").value}`, margin + sectionPadding, y + sectionPadding + 8); // Alinhado à esquerda
      doc.text(`E-mail: ${document.getElementById("clienteEmail").value}`, margin + sectionPadding, y + sectionPadding + 12); // Alinhado à esquerda
      doc.text(`Endereço da Obra: ${document.getElementById("clienteEndereco").value}`, margin + sectionPadding, y + sectionPadding + 16); // Alinhado à esquerda
      
      // --- Data e Número do Orçamento ---
      const dataAtual = new Date();
      const dataOrcamento = dataAtual.toLocaleDateString('pt-BR');
      const numeroOrcamento = `ORC-${dataAtual.getFullYear()}${(dataAtual.getMonth() + 1).toString().padStart(2, '0')}${dataAtual.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random() * 9000) + 1000}`; 

      doc.text(`Data: ${dataOrcamento}`, margin + sectionPadding, y + sectionPadding + 20); // Alinhado à esquerda
      doc.text(`Orçamento Nº: ${numeroOrcamento}`, margin + sectionPadding, y + sectionPadding + 24); // Alinhado à esquerda

      y += 32 + 5;

      // --- Seção de Produtos ---
      doc.setFillColor(headerColor);
      doc.rect(margin, y, doc.internal.pageSize.width - 2 * margin, 5, 'F');
      doc.setFontSize(9);
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, "bold");
      doc.text("PRODUTOS", margin + sectionPadding, y + 3.5); // Alinhado à esquerda
      y += 8;

      let totalGeralOrcamento = 0;

      const productItemFixedHeight = 47;

      for (let i = 0; i < produtosAdicionados.length; i++) {
        const produto = produtosAdicionados[i];

        if (y + productItemFixedHeight + 5 > doc.internal.pageSize.height - margin - 45) {
            doc.addPage();
            y = margin;

            // Repete o cabeçalho da página
            doc.setFillColor(headerColor);
            doc.rect(0, 0, doc.internal.pageSize.width, 22, 'F');
            if (logoImg) {
                doc.addImage(logoImg, 'PNG', margin, 2, 16, 16);
            } else {
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, "bold");
                doc.text("VIDROART", margin, 13);
            }
            doc.setFontSize(8);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, "normal");
            doc.text("Avenida Frei Florentino, 214, Centro, Muzambinho", doc.internal.pageSize.width - margin, 8, { align: "right" });
            doc.text("CNPJ: 19.397.220.0001/29", doc.internal.pageSize.width - margin, 12, { align: "right" });
            doc.text("Telefone: (35)3571-5750", doc.internal.pageSize.width - margin, 16, { align: "right" });
            doc.text("WhatsApp: (35)99162-4506", doc.internal.pageSize.width - margin, 20, { align: "right" });
            y = 31;


            // Repete o título "ORÇAMENTO" estilizado na nova página
            doc.setFontSize(titleFontSize);
            doc.setTextColor(headerColor);
            doc.setFont(undefined, "bold");
            const textWidthPage2 = doc.getStringUnitWidth("ORÇAMENTO (continuação)") * titleFontSize / doc.internal.scaleFactor;
            const centerXPage2 = (doc.internal.pageSize.width - textWidthPage2) / 2;
            const titleRectWidthPage2 = textWidthPage2 + 8;
            const titleRectXPage2 = (doc.internal.pageSize.width - titleRectWidthPage2) / 2;
            doc.setFillColor(lightGray);
            doc.rect(titleRectXPage2, y - 2, titleRectWidthPage2, titleRectHeight, 'F');
            doc.setDrawColor(headerColor);
            doc.setLineWidth(0.5);
            doc.rect(titleRectXPage2, y - 2, titleRectWidthPage2, titleRectHeight, 'S');
            doc.setTextColor(headerColor);
            doc.text("ORÇAMENTO (continuação)", centerXPage2, y + 5); // Centralizado
            y += titleRectHeight + 3;
            doc.setDrawColor(headerColor);
            doc.setLineWidth(0.4);
            doc.line(margin, y, doc.internal.pageSize.width - margin, y);
            y += 5;

            doc.setFillColor(headerColor);
            doc.rect(margin, y, doc.internal.pageSize.width - 2 * margin, 5, 'F');
            doc.setFontSize(9);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, "bold");
            doc.text("PRODUTOS (continuação)", margin + sectionPadding, y + 4.5); // Alinhado à esquerda
            y += 8;
        }

        // Desenha a borda do item do produto
        const productItemStart = y;
        doc.setDrawColor(borderColor);
        doc.setLineWidth(0.2);
        doc.rect(margin, y, doc.internal.pageSize.width - 2 * margin, productItemFixedHeight - 2, 'S');

        doc.setFontSize(7.5);
        doc.setTextColor(textColor);
        doc.setFont(undefined, "normal");

        let currentProductY = y + sectionPadding / 2;
        const textStartX = margin + sectionPadding;
        const imageStartX = margin + sectionPadding;
        const imageSize = 40;

        if (produto.foto) {
          const img = new Image();
          img.src = produto.foto;
          await new Promise(resolve => img.onload = resolve); 

          doc.addImage(img, "JPEG", imageStartX, currentProductY, imageSize, imageSize);
          
          let textOffset = imageSize + 3;
          let tempTextY = currentProductY + 2;

          doc.setFont(undefined, "bold");
          doc.text(`${i + 1}. ${produto.nome}`, textStartX + textOffset, tempTextY); // Alinhado com o texto
          doc.setFont(undefined, "normal");
          tempTextY += lineSpacing;
          doc.text(`L x A: ${produto.largura}x${produto.altura}mm | Vidro: ${produto.vidro}`, textStartX + textOffset, tempTextY); // Alinhado com o texto
          tempTextY += lineSpacing;
          if (produto.corNome) {
            doc.setFillColor(produto.corHex);
            doc.rect(textStartX + textOffset, tempTextY - 3.5, 3, 3, 'F');
            doc.text(`Cor: ${produto.corNome}`, textStartX + textOffset + 5, tempTextY); // Alinhado com o texto
            tempTextY += lineSpacing;
          }
          // Adiciona a área apenas se ela tiver um valor
          if (produto.area) {
            doc.text(`Qtd: ${produto.quantidade} | Área: ${produto.area}m² | V. Unit: R$ ${parseFloat(produto.valorUnitario).toFixed(2)}`, textStartX + textOffset, tempTextY); // Alinhado com o texto
          } else {
            doc.text(`Qtd: ${produto.quantidade} | V. Unit: R$ ${parseFloat(produto.valorUnitario).toFixed(2)}`, textStartX + textOffset, tempTextY); // Alinhado com o texto
          }
          tempTextY += lineSpacing + 1;
          doc.setFont(undefined, "bold");
          doc.text(`VALOR TOTAL: R$ ${parseFloat(produto.valorTotal).toFixed(2)}`, textStartX + textOffset, tempTextY); // Alinhado com o texto
          doc.setFont(undefined, "normal");

          y = productItemStart + productItemFixedHeight;
        } else {
          let tempTextY = currentProductY + 2;

          doc.setFont(undefined, "bold");
          doc.text(`${i + 1}. ${produto.nome}`, textStartX, tempTextY); // Alinhado à esquerda
          doc.setFont(undefined, "normal");
          tempTextY += lineSpacing;
          doc.text(`L x A: ${produto.largura}x${produto.altura}mm | Vidro: ${produto.vidro}`, textStartX, tempTextY); // Alinhado à esquerda
          tempTextY += lineSpacing;
          if (produto.corNome) {
            doc.setFillColor(produto.corHex);
            doc.rect(textStartX, tempTextY - 3.5, 3, 3, 'F');
            doc.text(`Cor: ${produto.corNome}`, textStartX + 5, tempTextY); // Alinhado à esquerda
            tempTextY += lineSpacing;
          }
          // Adiciona a área apenas se ela tiver um valor
          if (produto.area) {
            doc.text(`Qtd: ${produto.quantidade} | Área: ${produto.area}m² | V. Unit: R$ ${parseFloat(produto.valorUnitario).toFixed(2)}`, textStartX, tempTextY); // Alinhado à esquerda
          } else {
            doc.text(`Qtd: ${produto.quantidade} | V. Unit: R$ ${parseFloat(produto.valorUnitario).toFixed(2)}`, textStartX, tempTextY); // Alinhado à esquerda
          }
          tempTextY += lineSpacing + 1;
          doc.setFont(undefined, "bold");
          doc.text(`VALOR TOTAL: R$ ${parseFloat(produto.valorTotal).toFixed(2)}`, textStartX, tempTextY); // Alinhado à esquerda
          doc.setFont(undefined, "normal");

          y = productItemStart + productItemFixedHeight;
        }
        totalGeralOrcamento += parseFloat(produto.valorTotal);
        y += 2;
      }

      // --- Resumo do Orçamento ---
      y += 5;
      doc.setDrawColor(borderColor);
      doc.setLineWidth(0.4);
      // Linha acima do subtotal alinhada à direita
      doc.line(doc.internal.pageSize.width - margin - 60, y, doc.internal.pageSize.width - margin, y);

      doc.setFontSize(8.5);
      doc.setTextColor(textColor);
      doc.setFont(undefined, "normal");
      // Subtotal alinhado à direita
      doc.text(`SUBTOTAL:`, doc.internal.pageSize.width - margin - 55, y + lineSpacing, { align: "left" });
      doc.text(`R$ ${totalGeralOrcamento.toFixed(2)}`, doc.internal.pageSize.width - margin, y + lineSpacing, { align: "right" });
      y += lineSpacing;

      const percentualDesconto = parseFloat(document.getElementById("percentualDesconto").value) || 0;
let valorDesconto = 0;
let valorFinalComDesconto = totalGeralOrcamento;

if (percentualDesconto > 0) {
  valorDesconto = totalGeralOrcamento * (percentualDesconto / 100);
  valorFinalComDesconto = totalGeralOrcamento - valorDesconto;

  doc.text(`DESCONTO (${percentualDesconto.toFixed(1)}%):`, doc.internal.pageSize.width - margin - 55, y + lineSpacing, { align: "left" });
  doc.text(`- R$ ${valorDesconto.toFixed(2)}`, doc.internal.pageSize.width - margin, y + lineSpacing, { align: "right" });
  y += lineSpacing;
}

      doc.setDrawColor(headerColor);
      doc.setLineWidth(0.7);
      // Linha mais grossa alinhada à direita
      doc.line(doc.internal.pageSize.width - margin - 60, y + lineSpacing / 2, doc.internal.pageSize.width - margin, y + lineSpacing / 2);

      doc.setFontSize(10.5);
      doc.setTextColor(headerColor);
      doc.setFont(undefined, "bold");
      // Valor Final alinhado à direita
      doc.text(`VALOR FINAL:`, doc.internal.pageSize.width - margin - 55, y + lineSpacing + 3, { align: "left" });
      doc.text(`R$ ${valorFinalComDesconto.toFixed(2)}`, doc.internal.pageSize.width - margin, y + lineSpacing + 3, { align: "right" });
      y += lineSpacing + 5;

      // --- Formas de Pagamento (Movido para cá) ---
      doc.setFontSize(8.5);
      doc.setTextColor(headerColor);
      doc.setFont(undefined, "bold");
      doc.text("FORMAS DE PAGAMENTO:", margin, y); // Alinhado à esquerda
      doc.setFont(undefined, "normal");
      doc.setTextColor(textColor);
      doc.text("Cartão de Crédito/Débito, Pix, Cheque", margin, y + lineSpacing); // Alinhado à esquerda
      y += lineSpacing * 2; // Espaçamento após as formas de pagamento

      // --- Rodapé para Assinaturas ---
      y = doc.internal.pageSize.height - margin - 20;

      doc.setDrawColor(borderColor);
      doc.setLineWidth(0.4);
      // Linhas de assinatura alinhadas para dar espaço
      doc.line(margin + 10, y, margin + 70, y); // Linha para assinatura do cliente (esquerda)
      doc.line(doc.internal.pageSize.width - margin - 70, y, doc.internal.pageSize.width - margin - 10, y); // Linha para assinatura da empresa (direita)

      doc.setFontSize(7);
      doc.setTextColor(textColor);
      doc.text("Assinatura do Cliente", margin + 20, y + 3); // Texto alinhado com a linha do cliente
      doc.text("Assinatura da VIDROART", doc.internal.pageSize.width - margin - 60, y + 3); // Texto alinhado com a linha da empresa

      doc.setFontSize(6.5);
      doc.setTextColor(150);
      doc.text(`Página 1 de 1`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 6, { align: "center" }); // Centralizado

      // --- Salvar o histórico local ---
const nomeArquivo = `Orçamento_${new Date().toLocaleDateString('pt-BR')}_${new Date().toLocaleTimeString('pt-BR').replace(/:/g, '-')}.pdf`;

// Captura dados importantes do orçamento
const nomeCliente = document.getElementById("clienteNome").value || "Cliente não informado";
const valorTotal = document.querySelector("#listaProdutos")
  ? Array.from(document.querySelectorAll("#listaProdutos .text-md"))
      .reduce((acc, el) => {
        const match = el.textContent.match(/R\$ ([\d.,]+)/);
        return match ? acc + parseFloat(match[1].replace(",", ".")) : acc;
      }, 0)
      .toFixed(2)
  : "0.00";

// Adiciona ao localStorage
let historico = JSON.parse(localStorage.getItem('historicoPDFs')) || [];
historico.push({
  nome: nomeArquivo,
  cliente: nomeCliente,
  valor: valorTotal,
  data: new Date().toLocaleString('pt-BR'),
  dadosCliente: {
    nome: document.getElementById("clienteNome").value,
    telefone: document.getElementById("clienteTelefone").value,
    email: document.getElementById("clienteEmail").value,
    endereco: document.getElementById("clienteEndereco").value,
    pagamentoAVista: false

  },
  produtos: produtosAdicionados
});
localStorage.setItem('historicoPDFs', JSON.stringify(historico));

// Gera o PDF e abre em nova aba
window.open(doc.output('bloburl'), '_blank');


    }

    // --- JavaScript para a barra de progresso de rolagem ---
function updateProgressBar() {
  const progressBar = document.getElementById("progressBar");
  window.addEventListener("scroll", () => {
    const scrollTop = window.scrollY;
    const docHeight = document.body.scrollHeight - window.innerHeight;
    const scrollPercent = (scrollTop / docHeight) * 100;
    progressBar.style.width = `${scrollPercent}%`;
  });
}
document.addEventListener('DOMContentLoaded', updateProgressBar);

// --- Controle do Modal de Histórico ---
document.addEventListener('DOMContentLoaded', () => {
  const btnHistorico = document.getElementById('btnHistorico');
  const modalHistorico = document.getElementById('modalHistorico');
  const listaHistorico = document.getElementById('listaHistorico');
  const limparHistorico = document.getElementById('limparHistorico');
  const fecharHistorico = document.getElementById('fecharHistorico');

  if (!btnHistorico || !modalHistorico) {
    console.warn('Elemento do histórico não encontrado.');
    return;
  }

 btnHistorico.addEventListener("click", () => {
  atualizarGestaoFinanceira(); // Atualiza os totais antes de exibir
  const historico = JSON.parse(localStorage.getItem("historicoPDFs")) || [];
  listaHistorico.innerHTML = "";

  if (historico.length === 0) {
    listaHistorico.innerHTML = `<li class="text-center text-gray-500 py-2">Nenhum orçamento salvo ainda.</li>`;
    return;
  }

  historico.slice().reverse().forEach((item, i) => {
    const realIndex = historico.length - 1 - i;
    const primeiraFoto = item.produtos?.[0]?.foto || "";
    const concluido = item.concluido === true;

    const li = document.createElement("li");
    li.className = "flex justify-between items-center border-b py-2 text-sm bg-gray-50 hover:bg-gray-100 transition rounded-lg px-3";
    li.innerHTML = `
      <div class="flex items-center gap-3">
        ${primeiraFoto ? `<img src="${primeiraFoto}" class="w-14 h-14 rounded-lg border border-gray-300 object-cover">` : ""}
        <div>
          <span class="font-semibold text-green-700">${item.cliente || "Cliente não informado"}</span><br>
          <span class="text-gray-600">${item.nome}</span><br>
          <span class="text-gray-500 text-xs">${item.data}</span>
        </div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <span class="text-gray-800 font-bold block mb-1">R$ ${item.valor}</span>
        <div class="flex gap-2">
          <button onclick="enviarWhatsApp(${realIndex})"
            class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition flex items-center gap-1">
            <i class="fab fa-whatsapp"></i> Enviar
          </button>
          <button onclick="editarOrcamento(${realIndex})"
            class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition">✏️ Editar</button>
          <button onclick="removerOrcamento(${realIndex})"
            class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition">🗑️ Excluir</button>
          ${
            concluido
              ? `<button disabled class='bg-gray-400 text-white px-3 py-1 rounded-lg cursor-not-allowed'>✔️ Concluído</button>`
              : `<button onclick="concluirVenda(${realIndex})" class="bg-amber-500 text-white px-3 py-1 rounded-lg hover:bg-amber-600 transition">✅ Concluir</button>`
          }
        </div>
      </div>
    `;
    listaHistorico.appendChild(li);
  });

  modalHistorico.classList.remove("hidden");
});



  fecharHistorico.addEventListener('click', () => modalHistorico.classList.add('hidden'));

  limparHistorico.addEventListener('click', () => {
    if (confirm("Apagar todo o histórico?")) {
      localStorage.removeItem('historicoPDFs');
      listaHistorico.innerHTML = `<li class="text-center text-gray-500 py-2">Histórico limpo.</li>`;
      setTimeout(() => modalHistorico.classList.add('hidden'), 1000);
    }
  });
});

// ✏️ Função para editar um orçamento salvo
// 🔽 Função para simular download do PDF salvo (futuro)
window.baixarOrcamento = function(index) {
  const historico = JSON.parse(localStorage.getItem('historicoPDFs')) || [];
  const item = historico[index];
  if (!item) return alert("Arquivo não encontrado.");
  alert(`Aqui entrará o download do arquivo '${item.nome}' — futuro recurso.`);
};

// ✏️ Função para editar um orçamento salvo
// ✏️ Corrigido: editar orçamentos antigos e novos
window.editarOrcamento = function(index) {
  const historico = JSON.parse(localStorage.getItem('historicoPDFs')) || [];
  const orcamento = historico[index];
  if (!orcamento) return alert("Orçamento não encontrado.");

  // Fecha o modal do histórico
  document.getElementById("modalHistorico").classList.add("hidden");

  // Garante compatibilidade com versões antigas do histórico
  const dados = orcamento.dadosCliente || {};
  document.getElementById("clienteNome").value = dados.nome || orcamento.cliente || "";
  document.getElementById("clienteTelefone").value = dados.telefone || "";
  document.getElementById("clienteEmail").value = dados.email || "";
  document.getElementById("clienteEndereco").value = dados.endereco || "";

  // Carrega produtos
  produtosAdicionados = orcamento.produtos || [];
  renderizarProdutosAdicionados();

  // Mostra aviso visual moderno
  const aviso = document.createElement("div");
  aviso.textContent = `✏️ Editando orçamento de ${dados.nome || orcamento.cliente || "cliente"}`;
  aviso.className = "fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in";
  document.body.appendChild(aviso);
  setTimeout(() => aviso.remove(), 2500);

  // Rola até o painel de orçamento
  document.getElementById("orcamento").scrollIntoView({ behavior: "smooth" });
};


// 🗑️ Função para remover um orçamento específico
window.removerOrcamento = function(index) {
  let historico = JSON.parse(localStorage.getItem('historicoPDFs')) || [];
  const item = historico[index];
  if (!item) return alert("Orçamento não encontrado.");

  if (confirm(`Deseja realmente excluir o orçamento de ${item.cliente}?`)) {
    historico.splice(index, 1); // remove apenas esse orçamento
    localStorage.setItem('historicoPDFs', JSON.stringify(historico));
    alert("Orçamento removido com sucesso!");
    // Atualiza a lista automaticamente
    document.getElementById('btnHistorico').click();
  }
};

    // 💬 Enviar orçamento via WhatsApp
window.enviarWhatsApp = function (index) {
  const historico = JSON.parse(localStorage.getItem("historicoPDFs")) || [];
  const item = historico[index];
  if (!item) return alert("Orçamento não encontrado.");

  const numeroCliente = document.getElementById("clienteTelefone").value.replace(/\D/g, "");
  if (!numeroCliente) return alert("Preencha o número do cliente no campo 'Telefone'.");

  const mensagem = encodeURIComponent(
    `Olá ${item.cliente || "cliente"}, tudo bem? 👋\n\nSegue seu orçamento da VIDROART 📋\nValor total: R$ ${item.valor}\n\n(Abra o PDF gerado e envie o link manualmente caso não esteja hospedado)`
  );

  const link = `https://wa.me/55${numeroCliente}?text=${mensagem}`;
  window.open(link, "_blank");
};

    // 💰 Gestão Financeira
function atualizarGestaoFinanceira() {
  const historico = JSON.parse(localStorage.getItem("historicoPDFs")) || [];
  const mesAtual = new Date().getMonth();
  const anoAtual = new Date().getFullYear();

  const orcamentosMes = historico.filter(o => {
    const data = new Date(o.data);
    return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
  });

  let totalOrcado = 0;
  let totalConcluido = 0;

  orcamentosMes.forEach(o => {
    const valor = parseFloat(String(o.valor).replace(",", ".").replace("R$", "").trim()) || 0;
    totalOrcado += valor;
    if (o.concluido === true) totalConcluido += valor;
  });

  const lucroEstimado = totalConcluido * 0.25;
  const percentualConversao =
    totalOrcado > 0 ? ((totalConcluido / totalOrcado) * 100).toFixed(1) : 0;

  document.getElementById("totalOrcado").textContent = `R$ ${totalOrcado.toFixed(2)}`;
  document.getElementById("totalAprovado").textContent = `R$ ${totalConcluido.toFixed(2)}`;
  document.getElementById("lucroEstimado").textContent = `R$ ${lucroEstimado.toFixed(2)}`;
  document.getElementById("percentualConversao").textContent = `${percentualConversao}%`;
}


// 📤 Exportar relatório mensal
function exportarRelatorio(tipo) {
  const mes = new Date().toLocaleString("pt-BR", { month: "long" });
  const ano = new Date().getFullYear();
  const titulo = `Relatório Mensal – ${mes.charAt(0).toUpperCase() + mes.slice(1)} ${ano}`;

  if (tipo === "pdf") {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(titulo, 20, 20);
    doc.text(document.getElementById("gestaoFinanceira").innerText, 20, 40);
    doc.save(`${titulo}.pdf`);
  } else if (tipo === "excel") {
    let conteudo = "Categoria\tValor\n";
    conteudo += `Total Orçado\t${document.getElementById("totalOrcado").innerText}\n`;
    conteudo += `Total Aprovado\t${document.getElementById("totalAprovado").innerText}\n`;
    conteudo += `Lucro Estimado\t${document.getElementById("lucroEstimado").innerText}\n`;
    conteudo += `Conversão\t${document.getElementById("percentualConversao").innerText}\n`;
    const blob = new Blob([conteudo], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${titulo}.xls`;
    link.click();
  }
}

// 🔄 Atualiza junto com o histórico
function atualizarHistoricoComGestao() {
  const btnHistorico = document.getElementById("btnHistorico");
  btnHistorico.addEventListener("click", () => {
    atualizarGestaoFinanceira();
  });
}
document.addEventListener("DOMContentLoaded", atualizarHistoricoComGestao);

    function concluirVenda(index) {
  const historico = JSON.parse(localStorage.getItem("historicoPDFs")) || [];
  if (!historico[index]) return;

  if (confirm(`Marcar o orçamento de ${historico[index].cliente} como concluído?`)) {
    // Marca e salva
    historico[index].concluido = true;
    localStorage.setItem("historicoPDFs", JSON.stringify(historico));

    // Atualiza o painel imediatamente
    atualizarGestaoFinanceira();

    // Fecha e reabre o modal (pra recarregar a lista)
    modalHistorico.classList.add("hidden");
    setTimeout(() => {
      btnHistorico.click();
    }, 100);

    // Feedback
    alert("Venda concluída com sucesso!");
  }
}




  </script>
</body>
</html>
